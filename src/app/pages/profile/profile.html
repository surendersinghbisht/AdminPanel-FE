<app-loader [loading]="isLoading"></app-loader>
<div class="profile-container">
    <div class="profile-header">
      <h2 class="profile-title">Profile Settings</h2>
      <p class="profile-subtitle">Update your personal information and password</p>
    </div>
  
    <form [formGroup]="userForm" autocomplete="off" class="profile-form">
      
      <!-- Personal Information Section -->
      <div class="form-section">
        <h3 class="section-title">Personal Information</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Name <span class="required">*</span></label>
            <input type="text"  formControlName="Name" autocomplete="given-name" class="form-input" placeholder="Enter name" />
            <div class="error-message" *ngIf="userForm.get('Name')?.touched && userForm.get('Name')?.invalid">
              <span *ngIf="userForm.get('Name')?.errors?.['required']">Name is required</span>
              <span *ngIf="userForm.get('Name')?.errors?.['minlength']">Minimum 2 characters</span>
              <span *ngIf="userForm.get('Name')?.errors?.['maxlength']">Maximum 50 characters</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Username <span class="required">*</span></label>
            <input type="text"  formControlName="username" autocomplete="given-name" class="form-input" placeholder="Enter name" />
            <div class="error-message" *ngIf="userForm.get('username')?.touched && userForm.get('username')?.invalid">

              <span *ngIf="userForm.get('username')?.errors?.['required']">Username is required.</span>
<span *ngIf="!userForm.get('username')?.errors?.['required'] && userForm.get('username')?.errors?.['pattern']">
  Only alphanumeric characters allowed.
</span>
<span *ngIf="!userForm.get('username')?.errors?.['required'] && !userForm.get('username')?.errors?.['pattern'] && userForm.get('username')?.errors?.['minlength']">
  Minimum 4 characters required.
</span>
<span *ngIf="!userForm.get('username')?.errors?.['required'] && !userForm.get('username')?.errors?.['pattern'] && !userForm.get('username')?.errors?.['minlength'] && userForm.get('username')?.errors?.['maxlength']">
  Maximum 50 characters allowed.
</span>

      </div>
          </div>

        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email <span class="required">*</span></label>
            <input type="email"  formControlName="email" autocomplete="email" class="form-input" placeholder="Enter email address" />
            <div class="error-message" *ngIf="userForm.get('email')?.touched && userForm.get('email')?.invalid">
              <span *ngIf="userForm.get('email')?.errors?.['required']">Email is required</span>
              <span *ngIf="userForm.get('email')?.errors?.['email']">Invalid email format</span>
              <span *ngIf="userForm.get('email')?.errors?.['maxlength']">Maximum 100 characters</span>
            </div>
          </div>
  
          <div class="form-group">
            <label class="form-label">Phone <span class="required">*</span></label>
            <ngx-intl-tel-input
              class="tel-input-custom"
              [cssClass]="'form-input-tel'"
              [preferredCountries]="preferredCountries"
              [enableAutoCountrySelect]="true"
              [enablePlaceholder]="true"
              [searchCountryFlag]="true"
              [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
              [selectFirstCountry]="false"
              [selectedCountryISO]="CountryISO.India"
              [maxLength]="15"
              [phoneValidation]="true"
              [separateDialCode]="false"
              name="phone"
              formControlName="phone">
          </ngx-intl-tel-input>
            <div class="error-message" *ngIf="userForm.get('phone')?.touched && userForm.get('phone')?.invalid">
              <span *ngIf="userForm.get('phone')?.errors?.['required']">Phone number is required</span>
              <span *ngIf="userForm.get('phone')?.errors?.['validatePhoneNumber']">Invalid phone number</span>
            </div>
          </div>


           <div class="form-group">
            <label class="form-label">Dob <span class="required">*</span></label>
               <input 
          type="date" 
          id="dob"
          formControlName="dob" 
          [max]="today"
          class="form-input "
        />
            <div class="error-message" *ngIf="userForm.get('dob')?.touched && userForm.get('dob')?.invalid">
              <span *ngIf="userForm.get('dob')?.errors?.['required']">Dob is required</span>
              <span *ngIf="userForm.get('dob')?.errors?.['futureDate']">Date cannot be in the future.</span>
      </div>
          </div>
        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Role<span class="required">*</span></label>
            <input type="text" formControlName="role" readonly class="form-input readonly-input" />
          </div>
  
          <div class="form-group">
            <label class="form-label">Status<span class="required">*</span></label>
            <input type="text" formControlName="status" readonly class="form-input readonly-input" />
          </div>
        </div>
  
        <!-- Profile Picture Section -->
        <div class="form-group">
          <label class="form-label">Profile Picture</label>
          <div class="image-upload-section">
            <div class="image-preview-container">
              <img *ngIf="imagePreview" [src]="imagePreview" alt="Profile Preview" class="preview-image" />
              <div *ngIf="!imagePreview" class="preview-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <p>No image selected</p>
              </div>
            </div>
            <div class="file-input-wrapper">
              <input type="file" (change)="onFileSelected($event)" accept="image/*" id="fileInput" class="file-input" />
              <label for="fileInput" class="file-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Choose Image
              </label>
              <button *ngIf="imagePreview" type="button" class="btn-remove-image" (click)="removeImage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Remove
              </button>
            </div>
          </div>
        </div>
  
        <!-- Update Profile Button -->
        <div class="form-actions">
          <button type="button" class="btn-primary" (click)="updateProfile()" [disabled]="isLoading">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            {{ isLoading ? 'Updating...' : 'Update Profile' }}
          </button>
        </div>
      </div>
  
      <!-- Hidden dummy fields to prevent autofill -->
      <input type="text" style="display:none" autocomplete="username" />
      <input type="password" style="display:none" autocomplete="new-password" />
  
      <!-- Password Section -->
      <div class="form-section">
        <h3 class="section-title">Change Password</h3>
        <p class="section-description">Fill in all fields to change your password (minimum 8 characters)</p>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Old Password</label>
            <div class="password-input-wrapper">
              <input 
                [type]="showOldPassword ? 'text' : 'password'"
                formControlName="oldPassword" 
                autocomplete="new-password"
                placeholder="Enter current password"
                class="form-input password-input"
                readonly 
                onfocus="this.removeAttribute('readonly');" />
              <button type="button" class="password-toggle" (click)="togglePasswordVisibility('old')">
                <svg *ngIf="!showOldPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg *ngIf="showOldPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="error-message" *ngIf="userForm.errors?.['oldRequired'] && userForm.get('oldPassword')?.touched">
              <span>Old password is required when changing password</span>
            </div>
          </div>
        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">New Password</label>
            <div class="password-input-wrapper">
              <input 
                [type]="showNewPassword ? 'text' : 'password'"
                formControlName="newPassword" 
                autocomplete="new-password"
                appNoSpaces
                placeholder="Enter new password (min 8 characters)"
                class="form-input password-input"
                readonly 
                onfocus="this.removeAttribute('readonly');" />
              <button type="button" class="password-toggle" (click)="togglePasswordVisibility('new')">
                <svg *ngIf="!showNewPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg *ngIf="showNewPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="error-message" *ngIf="userForm.get('newPassword')?.touched && 
              (userForm.get('newPassword')?.errors || userForm.errors)">
              <span *ngIf="userForm.get('newPassword')?.errors?.['required']">
                Password is required.
              </span>
              <span *ngIf="userForm.get('newPassword')?.errors?.['weakPassword'] || userForm.errors?.['passwordLength']">
                Password must be at least 8 characters, include 1 uppercase, 1 number and 1 special character.
              </span>
            </div>
          </div>
  
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <div class="password-input-wrapper">
              <input 
                [type]="showConfirmPassword ? 'text' : 'password'"
                formControlName="confirmPassword" 
                autocomplete="off"
                placeholder="Confirm new password"
                class="form-input password-input"
                readonly 
                onfocus="this.removeAttribute('readonly');" />
              <button type="button" class="password-toggle" (click)="togglePasswordVisibility('confirm')">
                <svg *ngIf="!showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg *ngIf="showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="error-message" *ngIf="userForm.errors?.['confirmRequired'] && userForm.get('confirmPassword')?.touched">
              <span>Confirm password is required</span>
            </div>
            <div class="error-message" *ngIf="userForm.errors?.['mismatch'] && userForm.get('confirmPassword')?.touched">
              <span>Passwords do not match</span>
            </div>
          </div>
        </div>
  
        <!-- Change Password Button -->
        <div class="form-actions">
          <button type="button" class="btn-primary btn-password" (click)="changePassword()" 
          [disabled]="isPasswordInvalid() || isLoading">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            {{ isLoading ? 'Updating...' : 'Change Password' }}
          </button>
        </div>
      </div>
  
    </form>
  </div>